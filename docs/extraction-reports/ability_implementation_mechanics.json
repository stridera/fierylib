{
  "saving_throws": {
    "types": ["SAVING_PARA", "SAVING_ROD", "SAVING_PETRI", "SAVING_BREATH", "SAVING_SPELL"],
    "formula": "save = get_base_saves(ch, type) + GET_SAVE(ch, type); success if max(1, save) < random(0,99)",
    "source_files": {
      "mag_savingthrow": "magic.cpp:220-252",
      "get_base_saves": "chars.cpp:96-152"
    },
    "base_calculation": {
      "default_values": {
        "SAVING_PARA": 105,
        "SAVING_ROD": 115,
        "SAVING_PETRI": 105,
        "SAVING_BREATH": 110,
        "SAVING_SPELL": 110
      },
      "class_modifiers": "Each class has custom base saves array (classes[class].saves[])",
      "level_bonus": "-0.5 per level (saves[i] -= GET_LEVEL(ch)/2)",
      "source": "chars.cpp:98-113"
    },
    "stat_modifiers": {
      "SAVING_PARA": {
        "stat": "CON",
        "formula": "-0.5 * (GET_VIEWED_CON(ch) - 90)",
        "source": "chars.cpp:146"
      },
      "SAVING_SPELL": {
        "stat": "WIS",
        "formula": "-0.5 * (GET_VIEWED_WIS(ch) - 90)",
        "source": "chars.cpp:147"
      },
      "SAVING_ROD": {
        "stat": "DEX",
        "formula": "-0.5 * (GET_VIEWED_DEX(ch) - 90)",
        "source": "chars.cpp:148"
      },
      "SAVING_BREATH": {
        "stat": "DEX",
        "formula": "-0.5 * (GET_VIEWED_DEX(ch) - 90)",
        "source": "chars.cpp:149"
      },
      "SAVING_PETRI": {
        "stat": "none",
        "formula": "No stat bonus"
      }
    },
    "racial_bonuses": {
      "DWARF": {
        "SAVING_PARA": "-0.2 * GET_VIEWED_CON(ch)",
        "SAVING_ROD": "-0.1 * GET_VIEWED_CON(ch)",
        "SAVING_SPELL": "-0.15 * GET_VIEWED_CON(ch)",
        "source": "chars.cpp:118-123"
      },
      "DUERGAR": {
        "SAVING_PARA": "-0.2 * GET_VIEWED_CON(ch)",
        "SAVING_ROD": "-0.1 * GET_VIEWED_CON(ch)",
        "SAVING_SPELL": "-0.15 * GET_VIEWED_CON(ch)",
        "source": "chars.cpp:118-123"
      },
      "DRAGONBORN": {
        "SAVING_PARA": "-0.125 * GET_VIEWED_CON(ch)",
        "SAVING_ROD": "-0.1 * GET_VIEWED_CON(ch)",
        "SAVING_SPELL": "-0.1 * GET_VIEWED_CON(ch)",
        "source": "chars.cpp:124-132",
        "note": "Applies to all dragonborn types (FIRE, FROST, ACID, LIGHTNING, GAS)"
      },
      "GNOME": {
        "SAVING_ROD": "-0.1 * GET_VIEWED_CON(ch)",
        "SAVING_SPELL": "-0.1 * GET_VIEWED_CON(ch)",
        "source": "chars.cpp:133-137"
      },
      "SVERFNEBLIN": {
        "SAVING_ROD": "-0.1 * GET_VIEWED_CON(ch)",
        "SAVING_SPELL": "-0.1 * GET_VIEWED_CON(ch)",
        "source": "chars.cpp:133-137"
      },
      "HALFLING": {
        "SAVING_PARA": "-0.1 * GET_VIEWED_CON(ch)",
        "SAVING_ROD": "-0.1 * GET_VIEWED_CON(ch)",
        "SAVING_SPELL": "-0.1 * GET_VIEWED_CON(ch)",
        "source": "chars.cpp:138-142"
      }
    },
    "lower_is_better": true,
    "notes": [
      "Rolling 0 is always a failure (max(1, save) prevents this)",
      "Lower save number = better chance to resist",
      "Save modifiers from effects are ADDED to base saves (higher modifier = worse saves if positive)"
    ]
  },

  "effect_flags": {
    "EFF_BLESS": {
      "id": 78,
      "stat_modifiers": [
        {
          "location": "APPLY_SAVING_SPELL",
          "value": "-2 to -12",
          "formula": "-2 - (skill / 10)",
          "source": "magic.cpp:1230-1231"
        },
        {
          "location": "APPLY_DAMROLL",
          "value": "+1 to +2",
          "formula": "1 + (skill > 95)",
          "condition": "skill >= 55",
          "source": "magic.cpp:1243-1244"
        }
      ],
      "duration": {
        "formula": "10 + (skill / 7)",
        "range": "10-24 hours",
        "source": "magic.cpp:1232"
      },
      "special_effects": [
        "Barehand attacks can hurt ethereal characters (defines.hpp:486)",
        "Cannot hit ethereal targets without bless (damage.cpp:73)"
      ],
      "restrictions": [
        "Evil casters: Gods forsake them (CAST_SPELL only) (magic.cpp:1213-1217)",
        "Evil targets: Cannot bless evil characters (magic.cpp:1223-1228)",
        "Conflicts with SPELL_DARK_PRESENCE, SPELL_WINGS_OF_HEAVEN, SPELL_EARTH_BLESSING"
      ],
      "description": "Improves saves against spells and damage for good-aligned characters; allows physical attacks to hit ethereal beings",
      "checked_in": ["magic.cpp:1255", "fight.cpp:386", "fight.cpp:2123", "damage.cpp:73"],
      "ai_priority": 10
    },

    "EFF_BLIND": {
      "id": 0,
      "stat_modifiers": [
        {
          "location": "APPLY_HITROLL",
          "value": "-4",
          "source": "magic.cpp:1276-1277"
        },
        {
          "location": "APPLY_AC",
          "value": "-40",
          "source": "magic.cpp:1281-1282",
          "note": "Negative AC modifier makes AC worse"
        }
      ],
      "duration": {
        "formula": "2",
        "range": "2 hours fixed",
        "source": "magic.cpp:1278"
      },
      "special_effects": [
        "Character cannot see",
        "Severe combat penalties"
      ],
      "immunities": [
        "MOB_NOBLIND flag prevents blindness (magic.cpp:1264-1267)"
      ],
      "save_allowed": true,
      "save_type": "SAVING_SPELL",
      "description": "Severe combat penalties - massive AC penalty and hitroll reduction",
      "checked_in": ["magic.cpp:1279-1284"],
      "ai_priority": 50
    },

    "EFF_SANCTUARY": {
      "id": 7,
      "stat_modifiers": [],
      "duration": {
        "formula": "4",
        "range": "4 hours fixed",
        "source": "magic.cpp:2709-2710",
        "note": "Spell implementation appears incomplete"
      },
      "special_effects": [
        "Damage reduction: 50% (dam >>= 1)",
        "Prevents charming (spells.cpp:243-244)",
        "Visual aura: black for evil, white for good (act.informative.cpp:625-630)"
      ],
      "damage_reduction": {
        "formula": "dam >>= 1",
        "percentage": "50%",
        "source": "fight.cpp:1650-1651"
      },
      "description": "Reduces all incoming damage by 50%; prevents charm effects",
      "checked_in": ["fight.cpp:1650", "spells.cpp:243", "act.informative.cpp:625"],
      "ai_priority": 90
    },

    "EFF_HASTE": {
      "id": 24,
      "stat_modifiers": [],
      "duration": {
        "formula": "2 + (skill / 21)",
        "range": "2-6 hours",
        "source": "magic.cpp:2112"
      },
      "special_effects": [
        "Grants +1 attack per round",
        "Stacks with double attack skill"
      ],
      "attack_bonus": {
        "formula": "hits += 1",
        "source": "fight.cpp:2397-2398"
      },
      "description": "Increases attack speed by granting one additional attack per round",
      "checked_in": ["fight.cpp:2397"],
      "ai_priority": 50
    },

    "EFF_BLUR": {
      "id": 25,
      "stat_modifiers": [],
      "duration": {
        "formula": "2 + (skill / 21)",
        "range": "2-6 hours",
        "source": "magic.cpp:1294"
      },
      "special_effects": [
        "Grants +1 attack per round",
        "Image appears blurred"
      ],
      "attack_bonus": {
        "formula": "hits += 1",
        "source": "fight.cpp:2399-2400"
      },
      "description": "Increases attack speed through supernatural movement; grants one additional attack per round",
      "checked_in": ["fight.cpp:2399"],
      "ai_priority": 80
    },

    "EFF_STONE_SKIN": {
      "id": 22,
      "stat_modifiers": [
        {
          "location": "APPLY_NONE",
          "value": "7-13 (modifier tracks charges)",
          "formula": "7 + (skill / 16)",
          "source": "magic.cpp:2853-2854",
          "note": "Modifier decreases by 1 each hit until 0"
        }
      ],
      "duration": {
        "formula": "2",
        "range": "2 hours fixed",
        "source": "magic.cpp:2855"
      },
      "special_effects": [
        "Damage reduction: 50% (dam >>= 1)",
        "Charge-based: 90% chance per hit to reduce modifier by 1",
        "When modifier reaches 0, effect ends early",
        "Only 10% chance hit damages normally (fight.cpp:2267-2270)"
      ],
      "damage_reduction": {
        "base": "50%",
        "formula": "dam >>= 1 (if stone skin active)",
        "charge_system": "90% chance to block attack (dam = random(0,3)) and decrease modifier",
        "source": "fight.cpp:1650, fight.cpp:2267-2270"
      },
      "refresh": false,
      "description": "Charge-based damage reduction - blocks most attacks for minimal damage until charges depleted",
      "checked_in": ["fight.cpp:1650", "fight.cpp:2267", "act.informative.cpp:592"],
      "ai_priority": 100
    },

    "EFF_CONFUSION": {
      "id": 8,
      "stat_modifiers": [],
      "duration": {
        "formula": "2 + skill / 40",
        "range": "2-4 hours",
        "source": "magic.cpp:1405"
      },
      "special_effects": [
        "Character has difficulty focusing on foes",
        "May attack wrong targets"
      ],
      "save_allowed": true,
      "save_bonus": {
        "formula": "(GET_DEX(victim) + GET_WIS(victim) - 100) / 10",
        "max": "10% additional save chance",
        "source": "magic.cpp:1397-1398"
      },
      "description": "Causes character to have difficulty targeting correct enemies in combat",
      "checked_in": ["magic.cpp:1404"],
      "refresh": false,
      "ai_priority": 60
    },

    "EFF_CURSE": {
      "id": 9,
      "stat_modifiers": [
        {
          "location": "APPLY_HITROLL",
          "value": "-1 to -3",
          "formula": "-1 - (skill / 50)",
          "source": "magic.cpp:1422-1424"
        },
        {
          "location": "APPLY_DAMROLL",
          "value": "-1 to -3",
          "formula": "-1 - (skill / 50)",
          "source": "magic.cpp:1426-1428"
        }
      ],
      "duration": {
        "formula": "5 + (skill / 14)",
        "range": "5-12 hours",
        "source": "magic.cpp:1423"
      },
      "accumulates": true,
      "save_allowed": true,
      "description": "Reduces combat effectiveness through hitroll and damroll penalties",
      "checked_in": ["magic.cpp:1425"],
      "ai_priority": 40
    },

    "EFF_POISON": {
      "id": 11,
      "stat_modifiers": [],
      "duration": "varies by spell",
      "special_effects": [
        "Periodic damage over time",
        "Can be cured with cure poison spell"
      ],
      "description": "Deals damage over time until cured",
      "source": "defines.hpp:419",
      "ai_priority": 60
    },

    "EFF_INVISIBLE": {
      "id": 1,
      "stat_modifiers": [],
      "duration": "varies by spell",
      "special_effects": [
        "Character cannot be seen by normal vision",
        "Requires detect invisibility to see"
      ],
      "description": "Makes character invisible to normal sight",
      "source": "defines.hpp:409",
      "ai_priority": 70
    },

    "EFF_DETECT_ALIGN": {
      "id": 2,
      "stat_modifiers": [],
      "duration": {
        "formula": "5 + (skill / 10)",
        "range": "5-15 hours",
        "source": "magic.cpp:1570"
      },
      "special_effects": [
        "Can see alignment auras on characters"
      ],
      "description": "Allows character to see the alignment of others",
      "checked_in": ["magic.cpp:1569"],
      "ai_priority": 10
    },

    "EFF_DETECT_INVIS": {
      "id": 3,
      "stat_modifiers": [
        {
          "location": "APPLY_PERCEPTION",
          "value": "varies",
          "source": "magic.cpp:1579"
        }
      ],
      "duration": {
        "formula": "5 + (skill / 10)",
        "range": "5-15 hours",
        "source": "magic.cpp:1581"
      },
      "special_effects": [
        "Can see invisible characters and objects"
      ],
      "description": "Allows character to see invisible entities",
      "checked_in": ["magic.cpp:1578"],
      "ai_priority": 40
    },

    "EFF_DETECT_MAGIC": {
      "id": 4,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Can detect magical auras"
      ],
      "description": "Allows character to sense magical items and effects",
      "source": "defines.hpp:412",
      "ai_priority": 20
    },

    "EFF_SENSE_LIFE": {
      "id": 5,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Can sense living beings even when hidden"
      ],
      "description": "Detects presence of living creatures regardless of visibility",
      "source": "defines.hpp:413",
      "ai_priority": 50
    },

    "EFF_WATERWALK": {
      "id": 6,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Can walk on water surfaces"
      ],
      "description": "Allows character to traverse water sectors",
      "source": "defines.hpp:414",
      "ai_priority": 20
    },

    "EFF_FLY": {
      "id": 20,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Can fly through the air",
        "Prevents falling damage"
      ],
      "description": "Grants ability to fly and avoid ground-based hazards",
      "source": "defines.hpp:428",
      "ai_priority": 60
    },

    "EFF_CHARM": {
      "id": 21,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Character follows and obeys caster",
        "Blocked by SANCTUARY"
      ],
      "description": "Character is magically compelled to serve the caster",
      "source": "defines.hpp:429",
      "checked_in": ["spells.cpp:243"],
      "ai_priority": 90
    },

    "EFF_INFRAVISION": {
      "id": 10,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Can see in darkness using heat vision"
      ],
      "description": "Grants ability to see in the dark",
      "source": "defines.hpp:418",
      "ai_priority": 30
    },

    "EFF_PROTECT_EVIL": {
      "id": 12,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Protection from evil creatures"
      ],
      "description": "Provides defensive bonuses against evil-aligned attackers",
      "source": "defines.hpp:420",
      "ai_priority": 50
    },

    "EFF_PROTECT_GOOD": {
      "id": 13,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Protection from good creatures"
      ],
      "description": "Provides defensive bonuses against good-aligned attackers",
      "source": "defines.hpp:421",
      "ai_priority": 50
    },

    "EFF_FEATHER_FALL": {
      "id": 36,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Prevents falling damage",
        "Slow descent when falling"
      ],
      "description": "Character falls slowly and safely",
      "source": "defines.hpp:444",
      "ai_priority": 30
    },

    "EFF_WATERBREATH": {
      "id": 37,
      "stat_modifiers": [],
      "duration": "varies",
      "special_effects": [
        "Can breathe underwater"
      ],
      "description": "Allows breathing in water sectors",
      "source": "defines.hpp:445",
      "ai_priority": 40
    }
  },

  "apply_locations": {
    "APPLY_NONE": {
      "id": 0,
      "effect": "No modification",
      "source": "handler.cpp:133"
    },
    "APPLY_STR": {
      "id": 1,
      "effect": "Modifies strength attribute",
      "formula": "GET_ACTUAL_STR(ch) += mod",
      "source": "handler.cpp:136-138"
    },
    "APPLY_DEX": {
      "id": 2,
      "effect": "Modifies dexterity attribute",
      "formula": "GET_ACTUAL_DEX(ch) += mod",
      "source": "handler.cpp:139-141"
    },
    "APPLY_INT": {
      "id": 3,
      "effect": "Modifies intelligence attribute",
      "formula": "GET_ACTUAL_INT(ch) += mod",
      "source": "handler.cpp:142-144"
    },
    "APPLY_WIS": {
      "id": 4,
      "effect": "Modifies wisdom attribute",
      "formula": "GET_ACTUAL_WIS(ch) += mod",
      "source": "handler.cpp:145-147"
    },
    "APPLY_CON": {
      "id": 5,
      "effect": "Modifies constitution attribute",
      "formula": "GET_ACTUAL_CON(ch) += mod",
      "source": "handler.cpp:148-150"
    },
    "APPLY_CHA": {
      "id": 6,
      "effect": "Modifies charisma attribute",
      "formula": "GET_ACTUAL_CHA(ch) += mod",
      "source": "handler.cpp:151-153"
    },
    "APPLY_LEVEL": {
      "id": 8,
      "effect": "Modifies character level",
      "formula": "GET_LEVEL(ch) += mod",
      "source": "handler.cpp:158-160",
      "note": "Dangerous - affects many derived stats"
    },
    "APPLY_AGE": {
      "id": 9,
      "effect": "Modifies character age",
      "formula": "ch->player.time.birth -= (mod * SECS_PER_MUD_YEAR)",
      "source": "handler.cpp:162-164"
    },
    "APPLY_CHAR_WEIGHT": {
      "id": 10,
      "effect": "Modifies character weight",
      "formula": "GET_WEIGHT(ch) += mod",
      "source": "handler.cpp:166-168"
    },
    "APPLY_CHAR_HEIGHT": {
      "id": 11,
      "effect": "Modifies character height",
      "formula": "GET_HEIGHT(ch) += mod",
      "source": "handler.cpp:170-172"
    },
    "APPLY_MANA": {
      "id": 12,
      "effect": "Modifies maximum mana (NOT IMPLEMENTED)",
      "note": "No code implementation found in handler.cpp"
    },
    "APPLY_HIT": {
      "id": 13,
      "effect": "Modifies maximum and current hit points",
      "formula": "GET_MAX_HIT(ch) += mod; GET_HIT(ch) += mod",
      "source": "handler.cpp:178-181"
    },
    "APPLY_MOVE": {
      "id": 14,
      "effect": "Modifies maximum and current movement points",
      "formula": "GET_MAX_MOVE(ch) += mod; GET_MOVE(ch) += mod",
      "source": "handler.cpp:183-186"
    },
    "APPLY_AC": {
      "id": 17,
      "effect": "Modifies armor class (INVERTED: negative AC is better)",
      "formula": "GET_AC(ch) -= mod",
      "source": "handler.cpp:195-198",
      "note": "Modifier is SUBTRACTED because lower AC = better protection"
    },
    "APPLY_HITROLL": {
      "id": 18,
      "effect": "Modifies chance to hit in combat",
      "formula": "GET_HITROLL(ch) += mod",
      "source": "handler.cpp:199-201",
      "note": "Higher is better"
    },
    "APPLY_DAMROLL": {
      "id": 19,
      "effect": "Modifies damage dealt in combat",
      "formula": "GET_DAMROLL(ch) += mod",
      "source": "handler.cpp:202-204",
      "note": "Higher is better"
    },
    "APPLY_SAVING_PARA": {
      "id": 20,
      "effect": "Modifies saving throw vs paralysis",
      "formula": "GET_SAVE(ch, SAVING_PARA) += mod",
      "source": "handler.cpp:205-207",
      "note": "LOWER is better (negative modifiers improve saves)"
    },
    "APPLY_SAVING_ROD": {
      "id": 21,
      "effect": "Modifies saving throw vs rods/staves/wands",
      "formula": "GET_SAVE(ch, SAVING_ROD) += mod",
      "source": "handler.cpp:209-211",
      "note": "LOWER is better (negative modifiers improve saves)"
    },
    "APPLY_SAVING_PETRI": {
      "id": 22,
      "effect": "Modifies saving throw vs petrification",
      "formula": "GET_SAVE(ch, SAVING_PETRI) += mod",
      "source": "handler.cpp:213-215",
      "note": "LOWER is better (negative modifiers improve saves)"
    },
    "APPLY_SAVING_BREATH": {
      "id": 23,
      "effect": "Modifies saving throw vs breath weapons",
      "formula": "GET_SAVE(ch, SAVING_BREATH) += mod",
      "source": "handler.cpp:217-219",
      "note": "LOWER is better (negative modifiers improve saves)"
    },
    "APPLY_SAVING_SPELL": {
      "id": 24,
      "effect": "Modifies saving throw vs spells",
      "formula": "GET_SAVE(ch, SAVING_SPELL) += mod",
      "source": "handler.cpp:221-223",
      "note": "LOWER is better (negative modifiers improve saves)"
    },
    "APPLY_SIZE": {
      "id": 25,
      "effect": "Modifies character size category",
      "formula": "adjust_size(ch, mod)",
      "source": "handler.cpp:188-190"
    },
    "APPLY_HIT_REGEN": {
      "id": 26,
      "effect": "Modifies hit point regeneration rate",
      "formula": "ch->char_specials.hitgain += mod",
      "source": "handler.cpp:225-227"
    },
    "APPLY_FOCUS": {
      "id": 27,
      "effect": "Modifies focus attribute",
      "formula": "GET_FOCUS(ch) += mod",
      "source": "handler.cpp:174-176"
    },
    "APPLY_PERCEPTION": {
      "id": 28,
      "effect": "Modifies perception ability",
      "formula": "GET_PERCEPTION(ch) += mod",
      "source": "handler.cpp:228-230",
      "note": "Used by detect invisibility and similar effects"
    },
    "APPLY_HIDDENNESS": {
      "id": 29,
      "effect": "Modifies stealth/hiding ability",
      "formula": "GET_HIDDENNESS(ch) = clamp(GET_HIDDENNESS(ch) + mod, 0, 1000)",
      "source": "handler.cpp:231-233",
      "note": "Clamped between 0 and 1000"
    },
    "APPLY_COMPOSITION": {
      "id": 30,
      "effect": "Changes character material composition",
      "formula": "convert_composition(ch, mod >= 0 ? mod : BASE_COMPOSITION(ch))",
      "source": "handler.cpp:234-239",
      "note": "Used for polymorph effects"
    }
  },

  "spell_durations": {
    "SPELL_ARMOR": {
      "formula": "10 + (skill / 50)",
      "range": "10-12 hours",
      "source": "magic.cpp:1182"
    },
    "SPELL_BARKSKIN": {
      "formula": "5 + (skill / 10)",
      "range": "5-15 hours",
      "source": "magic.cpp:1205"
    },
    "SPELL_BLESS": {
      "formula": "10 + (skill / 7)",
      "range": "10-24 hours",
      "source": "magic.cpp:1232"
    },
    "SPELL_BLINDNESS": {
      "formula": "2",
      "range": "2 hours fixed",
      "source": "magic.cpp:1278"
    },
    "SPELL_BLUR": {
      "formula": "2 + (skill / 21)",
      "range": "2-6 hours",
      "source": "magic.cpp:1294"
    },
    "SPELL_BONE_ARMOR": {
      "formula": "8 + 2 * (skill / 5)",
      "range": "8-48 hours",
      "source": "magic.cpp:1313"
    },
    "SPELL_COLDSHIELD": {
      "formula": "skill / 20",
      "range": "0-5 hours",
      "source": "magic.cpp:1386"
    },
    "SPELL_CONFUSION": {
      "formula": "2 + skill / 40",
      "range": "2-4 hours",
      "source": "magic.cpp:1405"
    },
    "SPELL_CURSE": {
      "formula": "5 + (skill / 14)",
      "range": "5-12 hours",
      "source": "magic.cpp:1423"
    },
    "SPELL_DARK_PRESENCE": {
      "formula": "10 + (skill / 7)",
      "range": "10-24 hours",
      "source": "magic.cpp:1465"
    },
    "SPELL_DEMONIC_ASPECT": {
      "formula": "5 + (skill / 20)",
      "range": "5-10 hours",
      "source": "magic.cpp:1513"
    },
    "SPELL_DETECT_ALIGN": {
      "formula": "5 + (skill / 10)",
      "range": "5-15 hours",
      "source": "magic.cpp:1570"
    },
    "SPELL_DETECT_INVIS": {
      "formula": "5 + (skill / 10)",
      "range": "5-15 hours",
      "source": "magic.cpp:1581"
    },
    "SPELL_HASTE": {
      "formula": "2 + (skill / 21)",
      "range": "2-6 hours",
      "source": "magic.cpp:2112"
    },
    "SPELL_STONE_SKIN": {
      "formula": "2",
      "range": "2 hours fixed",
      "source": "magic.cpp:2855",
      "note": "Duration often doesn't matter - ends when charges (modifier) reach 0"
    }
  },

  "combat_mechanics": {
    "attack_bonus": {
      "HASTE": {
        "bonus": "+1 attack per round",
        "source": "fight.cpp:2397-2398"
      },
      "BLUR": {
        "bonus": "+1 attack per round",
        "source": "fight.cpp:2399-2400"
      },
      "DOUBLE_ATTACK_SKILL": {
        "bonus": "×2 attacks if skill check passes",
        "source": "fight.cpp:2395-2396"
      }
    },
    "damage_reduction": {
      "SANCTUARY": {
        "reduction": "50%",
        "formula": "dam >>= 1",
        "source": "fight.cpp:1650-1651"
      },
      "STONE_SKIN": {
        "reduction": "50% base, 90% chance for near-complete reduction",
        "formula": "dam >>= 1 (base), then 90% chance: dam = random(0,3)",
        "charge_system": true,
        "source": "fight.cpp:1650, fight.cpp:2267-2270"
      }
    },
    "hitroll_modifiers": {
      "BLESS_vs_EVIL": {
        "bonus": "-level/5",
        "condition": "Good attacker vs evil target",
        "source": "fight.cpp:2124-2125",
        "note": "Negative bonus improves to-hit (lower THAC0)"
      },
      "BLESS_vs_NEUTRAL": {
        "bonus": "-level/10",
        "condition": "Good attacker vs neutral target",
        "source": "fight.cpp:2126-2127"
      },
      "BLIND": {
        "penalty": "-4",
        "source": "magic.cpp:1276-1277"
      },
      "CURSE": {
        "penalty": "-1 to -3",
        "formula": "-1 - (skill / 50)",
        "source": "magic.cpp:1422-1424"
      }
    },
    "ac_modifiers": {
      "ARMOR": {
        "bonus": "10-15",
        "formula": "10 + (skill / 20)",
        "source": "magic.cpp:1180-1181",
        "note": "Positive modifier improves AC (subtracted in handler)"
      },
      "BARKSKIN": {
        "bonus": "7-18",
        "formula": "7 + (skill / 9)",
        "source": "magic.cpp:1203-1204"
      },
      "BLIND": {
        "penalty": "-40",
        "source": "magic.cpp:1281-1282",
        "note": "Negative modifier worsens AC"
      }
    }
  },

  "implementation_notes": {
    "saving_throw_system": [
      "Lower save numbers are better (easier to resist spells)",
      "Save check: max(1, save) < random(0, 99)",
      "Rolling 0 is automatic failure",
      "Racial bonuses stack with stat bonuses",
      "Class determines base save array",
      "Level provides -0.5 per level bonus to all saves"
    ],
    "effect_flag_system": [
      "Effect flags grant special abilities or states",
      "Most effects have associated stat modifiers via APPLY locations",
      "Some effects (SANCTUARY, STONE_SKIN) directly modify combat calculations",
      "Effects can be set by spells, items, or racial abilities",
      "Effect duration measured in MUD hours"
    ],
    "apply_location_system": [
      "APPLY locations modify character stats when effect is active",
      "Modifiers are applied in effect_modify() (handler.cpp:130-246)",
      "AC modifier is SUBTRACTED (lower AC is better)",
      "Save modifiers are ADDED (negative modifiers improve saves)",
      "Stats are recalculated when effects change"
    ],
    "combat_calculations": [
      "Attack count: base 1, +1 for haste, +1 for blur, ×2 for double attack skill",
      "Damage reduction stacks multiplicatively (sanctuary + stone skin = 75% reduction)",
      "BLESS provides hitroll bonuses based on alignment matchup",
      "Stone skin uses charge system - modifier decreases until effect ends"
    ]
  }
}
